name: OpenTofu Test CI/CD

run-name: ${{ github.actor }} is testing OpenTofu CI/CDüöÄ
on:
  push:
    paths:
      - 'infra/github_action_tofu/*'

jobs:
  opentofu-plan:
    if: github.ref != 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Run a sample command
        run: echo "OpenTofu Test CI/CD is running!"
      # OpenTofu „Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_wrapper: opentofu
      # Áí∞Â¢ÉÂ§âÊï∞„Å®„Åó„Å¶ credentials „ÇíÊ∏°„Åô
      - name: Export SakuraCloud credentials
        run: |
          echo "SAKURACLOUD_ACCESS_TOKEN=${{ secrets.SAKURACLOUD_ACCESS_TOKEN }}" >> $GITHUB_ENV
          echo "SAKURACLOUD_ACCESS_TOKEN_SECRET=${{ secrets.SAKURACLOUD_ACCESS_TOKEN_SECRET }}" >> $GITHUB_ENV
          echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV

      # Terraform ÂàùÊúüÂåñ (backend „Å´ Sakura Cloud Object Storage)
      - name: opentofu Init
        run: |
          opentofu init \
            -backend-config="bucket=${{ secrets.OBJECT_STORAGE_NAME }}" \
            -backend-config="endpoint=${{ secrets.SAKURACLOUD_API_ENDPOINT }}" \
            -backend-config="access_key=${{ env.AWS_ACCESS_KEY_ID }}" \
            -backend-config="secret_key=${{ env.AWS_SECRET_ACCESS_KEY }}" \
            -backend-config="region=${{ secrets.SAKURACLOUD_REGION }}" \
            -backend-config="key=github/test/terraform.tfstate"

      - name: opentofu Plan
        run: opentofu plan -input=false -lock=true \
          -out=plan.out

      - name: Upload Planfile
        uses: actions/upload-artifact@v3
        with:
          name: tfplan-${{ github.ref_name }}
          path: plan.out